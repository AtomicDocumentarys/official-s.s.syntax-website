<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0b0e11; --nav: #15191c; --accent: #5865f2; --text: #f0f0f0; --border: #2d3238; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* TOP HEADER */
        header { height: 60px; background: var(--nav); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 100; }
        .dropdown-group { display: flex; gap: 15px; }
        select { background: #1e2327; color: white; border: 1px solid var(--border); padding: 8px 15px; border-radius: 5px; outline: none; cursor: pointer; min-width: 150px; }

        /* MAIN BODY */
        .wrapper { display: flex; flex-grow: 1; overflow: hidden; }

        /* SIDEBAR */
        nav { width: 240px; background: var(--nav); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 10px 0; }
        .nav-item { padding: 12px 25px; cursor: pointer; color: #b9bbbe; transition: 0.2s; display: flex; align-items: center; gap: 10px; text-decoration: none; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: #2d3238; color: white; border-left: 3px solid var(--accent); }
        .nav-category { font-size: 11px; color: #4f545c; padding: 20px 25px 5px; text-transform: uppercase; font-weight: bold; }

        /* CONTENT AREA */
        main { flex-grow: 1; padding: 30px; overflow-y: auto; background: var(--bg); position: relative; }
        .view { display: none; max-width: 1000px; margin: auto; }
        .view.active { display: block; }

        /* CARDS & ELEMENTS */
        .card { background: #181d21; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        #code-editor { height: 400px; border-radius: 5px; margin: 15px 0; border: 1px solid #333; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: var(--accent); color: white; }
        .btn-invite { background: #3ba55c; }
        
        .console { background: #000; color: #0f0; padding: 15px; height: 200px; border-radius: 5px; font-family: monospace; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: bold; color: var(--accent); font-size: 20px;">S.S. Syntax</div>
        <div class="dropdown-group">
            <select id="acc-select"><option>User Account</option></select>
            <select id="guild-select" onchange="serverChanged()"><option value="">Select Server</option></select>
            <button class="btn btn-invite" onclick="window.open('https://discord.com/api/oauth2/authorize?client_id=1466792124686008341&permissions=8&scope=bot')">Invite Bot</button>
        </div>
    </header>

    <div class="wrapper">
        <nav>
            <div class="nav-category">Navigation</div>
            <div class="nav-item active" onclick="switchTab('home')">üè† Home</div>
            <div class="nav-item" onclick="switchTab('commands')">üìú Custom Commands</div>
            
            <div class="nav-category">Core</div>
            <div class="nav-item" onclick="switchTab('database')">üóÑÔ∏è Database</div>
            <div class="nav-item" style="opacity: 0.5;">üì° Database (Coming Soon)</div>

            <div class="nav-category">Legal</div>
            <div class="nav-item" onclick="switchTab('terms')">üìë Terms of Service</div>
            <div class="nav-item" onclick="switchTab('privacy')">üõ°Ô∏è Privacy Policy</div>
            
            <div style="margin-top: auto; padding: 20px;">
                <button class="btn" style="width: 100%; background: #444;" onclick="login()">Re-Sync</button>
            </div>
        </nav>

        <main>
            <div id="view-home" class="view active">
                <h1>Welcome, <span id="user-name">Guest</span></h1>
                <p>Select a server from the dropdown above to begin managing your bot.</p>
                <div class="card">
                    <h3>Live Console Output</h3>
                    <div class="console" id="log-output">System initialized...</div>
                </div>
            </div>

            <div id="view-commands" class="view">
                <h2>Custom Commands</h2>
                <div id="editor-container" class="card" style="display:none;">
                    <input type="text" id="cmd-name" placeholder="Command Name (e.g. ping)" style="width:100%; padding:10px; background:#0b0e11; color:white; border:1px solid #333; margin-bottom:10px;">
                    <div id="code-editor"></div>
                    <button class="btn" onclick="saveCommand()">Save & Deploy</button>
                    <button class="btn" style="background:#444;" onclick="hideEditor()">Cancel</button>
                </div>
                <div id="command-list-container">
                    <button class="btn" onclick="showEditor()">+ Create New Command</button>
                    <div id="command-list" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="view-database" class="view">
                <h2>Server Database</h2>
                <div class="card">
                    <p>Stored Keys for this server:</p>
                    <div id="db-list">Please select a server first.</div>
                </div>
            </div>

            <div id="view-terms" class="view"><h2>Terms of Service</h2><p>Your terms go here...</p></div>
            <div id="view-privacy" class="view"><h2>Privacy Policy</h2><p>Your privacy policy goes here...</p></div>
        </main>
    </div>

    <script>
        const socket = io();
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");

        // TAB SWITCHING
        function switchTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tabId === 'commands') editor.resize();
        }

        // SERVER SELECTION
        async function serverChanged() {
            const guildId = document.getElementById('guild-select').value;
            if(!guildId) return;
            socket.emit('join-server', guildId);
            loadCommands(guildId);
            document.getElementById('db-list').innerText = "Fetching data for " + guildId + "...";
        }

        async function loadCommands(guildId) {
            const res = await fetch(`/api/commands/${guildId}`);
            const cmds = await res.json();
            const list = document.getElementById('command-list');
            list.innerHTML = cmds.map(c => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>!${c.name}</span>
                    <button class="btn" onclick='editCommand(${JSON.stringify(c)})'>Edit</button>
                </div>
            `).join('');
        }

        // EDITOR LOGIC
        function showEditor() { document.getElementById('editor-container').style.display = 'block'; document.getElementById('command-list-container').style.display = 'none'; editor.resize(); }
        function hideEditor() { document.getElementById('editor-container').style.display = 'none'; document.getElementById('command-list-container').style.display = 'block'; }

        function editCommand(c) {
            document.getElementById('cmd-name').value = c.name;
            editor.setValue(c.code, -1);
            showEditor();
        }

        async function saveCommand() {
            const guildId = document.getElementById('guild-select').value;
            const name = document.getElementById('cmd-name').value;
            const code = editor.getValue();
            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId, command: { id: Date.now(), name, code }})
            });
            alert("Saved!");
            hideEditor();
            loadCommands(guildId);
        }

        // AUTH & INITIALIZATION
        function login() { window.location.href = `https://discord.com/api/oauth2/authorize?client_id=1466792124686008341&redirect_uri=${encodeURIComponent(window.location.origin + '/callback.html')}&response_type=code&scope=identify+guilds`; }

        async function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (!token) return;
            
            // Get User Profile
            const userRes = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` } });
            const userData = await userRes.json();
            document.getElementById('user-name').innerText = userData.username;
            document.getElementById('acc-select').innerHTML = `<option>${userData.username}#${userData.discriminator}</option>`;

            // Get Guilds
            const guildRes = await fetch('https://discord.com/api/users/@me/guilds', { headers: { Authorization: `Bearer ${token}` } });
            const guilds = await guildRes.json();
            const select = document.getElementById('guild-select');
            guilds.filter(g => (BigInt(g.permissions) & 0x8n)).forEach(g => {
                select.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            });
        }

        socket.on('log', d => {
            const log = document.getElementById('log-output');
            log.innerHTML += `<div>[${d.timestamp}] ${d.message}</div>`;
            log.scrollTop = log.scrollHeight;
        });

        window.onload = checkAuth;
    </script>
</body>
                </html>
    
