<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <style>
        :root { --bg: #0b0e11; --side: #15191d; --card: #1c2127; --accent: #3ba55c; --err: #f04747; --text: #fff; --border: #2e3338; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Menu Fixes */
        .sidebar { width: 260px; background: var(--side); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .sidebar.closed { margin-left: -260px; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #b9bbbe; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #202429; color: #fff; border-left-color: var(--accent); }

        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .top-bar { height: 60px; background: #0b0e11; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 15px; }
        .menu-toggle { cursor: pointer; font-size: 24px; color: var(--accent); }

        main { flex: 1; padding: 20px; overflow-y: auto; }
        .view { display: none; max-width: 850px; margin: 0 auto; }
        .view.active { display: block; }

        /* YAGPDB Styling */
        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 4px; margin-bottom: 20px; }
        .cmd-limit-box { background: #2f343a; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
        .cmd-item { background: #202429; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        
        .input-black { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        #code-editor { height: 350px; border: 1px solid #333; border-radius: 4px; margin-bottom: 10px; }
        
        .btn-green { background: var(--accent); color: #fff; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-green:disabled { background: #2a5e3a; cursor: not-allowed; opacity: 0.6; }
        .btn-danger { background: var(--err); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: #4f545c; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="mySidebar" class="sidebar">
        <div style="padding: 20px; font-weight: bold; color: var(--accent); font-size: 1.2rem;">S.S. SYNTAX</div>
        <div class="nav-item active" onclick="tab('home')">Home</div>
        <div class="nav-item s-only" style="display:none" onclick="tab('commands')">Custom Commands</div>
        <div class="nav-item" onclick="tab('terms')">Terms of Service</div>
        <div class="nav-item" onclick="tab('privacy')">Privacy Policy</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="menu-toggle" onclick="toggleMenu()">☰</div>
            <select id="guild-select" class="input-black" style="width:250px; margin:0;" onchange="loadServer()">
                <option value="">Choose a Server</option>
            </select>
        </div>

        <main>
            <div id="v-home" class="view active">
                <div class="card">
                    <h1>Welcome to S.S. Syntax</h1>
                    <p>S.S. Syntax is your unified hub for high-performance Discord automation. By using localized runtimes for JavaScript, Python, and Golang, we offer the flexibility of advanced coding without the overhead of hosting your own bot.</p>
                    <p>Select a server from the top menu to access your custom command engine and database.</p>
                </div>
            </div>

            <div id="v-commands" class="view">
                <div id="list-container">
                    <div class="cmd-limit-box">
                        You have created <span id="cmd-count" style="color:var(--accent); font-weight:bold;">0</span> custom commands against the total limit of <b>100</b>.
                    </div>
                    <button class="btn-green" style="width:100%; margin-bottom:20px;" onclick="openEditor()">Create a new Custom Command</button>
                    <div id="commands-list"></div>
                </div>

                <div id="editor-container" style="display:none;">
                    <button class="btn-edit" onclick="closeEditor()" style="margin-bottom:10px;">← Back to List</button>
                    <div class="card">
                        <label>Language</label>
                        <select id="c-lang" class="input-black" onchange="changeLang()"><option value="javascript">JavaScript</option><option value="python">Python</option></select>
                        <label>Trigger</label>
                        <input type="text" id="c-trig" class="input-black" placeholder="e.g. math">
                        <div id="code-editor"></div>
                        <button id="save-btn" class="btn-green" onclick="save()" style="width:100%">CONFIRM COMMAND</button>
                    </div>
                </div>
            </div>
            
            <div id="v-terms" class="view"><div class="card"><h2>Terms</h2><p>Legal content here...</p></div></div>
            <div id="v-privacy" class="view"><div class="card"><h2>Privacy</h2><p>Legal content here...</p></div></div>
        </main>
    </div>

    <script>
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        let gid = null; let editingId = null;

        // SIDEBAR TOGGLE
        function toggleMenu() { document.getElementById("mySidebar").classList.toggle("closed"); }

        function tab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('v-' + t).classList.add('active');
            event.currentTarget.classList.add('active');
            if (window.innerWidth < 800) toggleMenu(); // Close on click for mobile
            if (t === 'commands') closeEditor();
        }

        function changeLang() {
            const lang = document.getElementById('c-lang').value;
            editor.session.setMode("ace/mode/" + lang);
        }

        // ERROR BLOCKER
        editor.getSession().on('changeAnnotation', function() {
            const annotations = editor.getSession().getAnnotations();
            const hasError = annotations.some(a => a.type === "error");
            document.getElementById('save-btn').disabled = hasError;
        });

        async function loadServer() {
            gid = document.getElementById('guild-select').value;
            if(!gid) return;
            document.querySelectorAll('.s-only').forEach(e => e.style.display = 'block');
            refreshCommands();
        }

        async function refreshCommands() {
            const res = await fetch('/api/commands/' + gid);
            const cmds = await res.json();
            document.getElementById('cmd-count').innerText = cmds.length;
            const list = document.getElementById('commands-list');
            list.innerHTML = cmds.map(c => `
                <div class="cmd-item">
                    <span>#${c.id.slice(-4)} - Command: <b>${c.trigger}</b></span>
                    <div>
                        <button class="btn-edit" onclick='openEditor(${JSON.stringify(c)})'>Edit</button>
                        <button class="btn-danger" onclick="del('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function openEditor(cmd = null) {
            document.getElementById('list-container').style.display = 'none';
            document.getElementById('editor-container').style.display = 'block';
            if(cmd) {
                editingId = cmd.id;
                document.getElementById('c-trig').value = cmd.trigger;
                editor.setValue(cmd.code);
            } else {
                editingId = null;
                document.getElementById('c-trig').value = '';
                editor.setValue('');
            }
            changeLang();
        }

        function closeEditor() {
            document.getElementById('list-container').style.display = 'block';
            document.getElementById('editor-container').style.display = 'none';
            refreshCommands();
        }

        async function save() {
            const cmd = {
                id: editingId || Date.now().toString(),
                isEdit: !!editingId,
                lang: document.getElementById('c-lang').options[document.getElementById('c-lang').selectedIndex].text,
                type: "Command (prefix)",
                trigger: document.getElementById('c-trig').value,
                code: editor.getValue()
            };
            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: gid, command: cmd })
            });
            closeEditor();
        }

        async function del(id) {
            if(confirm("Delete command?")) {
                await fetch(`/api/command/${gid}/${id}`, { method: 'DELETE' });
                refreshCommands();
            }
        }

        async function init() {
            const t = localStorage.getItem('discord_token');
            const res = await fetch('/api/mutual-servers', { headers: { Authorization: `Bearer ${t}` } });
            const guilds = await res.json();
            guilds.forEach(g => { document.getElementById('guild-select').innerHTML += `<option value="${g.id}">${g.name}</option>`; });
        }
        window.onload = init;
    </script>
</body>
    </html>
                
