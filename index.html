<!doctype html>
<html>
<body>
<script>
<div id="view-commands" class="view">
    <div class="card">
        <label>Programming Language</label>
        <select id="cmd-lang" class="input-black" onchange="updateEditorMode()">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="golang">Golang</option>
        </select>

        <label>Trigger Type</label>
        <select id="cmd-type" class="input-black" onchange="togglePrefix()">
            <option>Command (prefix)</option>
            <option>Starts with</option>
            <option>Contains</option>
            <option>Exact Match</option>
            <option>Regex</option>
        </select>

        <div id="prefix-container">
            <label>Command Prefix</label>
            <input type="text" id="cmd-prefix" class="input-black" value="!">
        </div>

        <label>Trigger Name</label>
        <input type="text" id="cmd-trigger" class="input-black" placeholder="e.g. math">

        <label>Code Editor</label>
        <div id="code-editor"></div>
        <div id="error-box" class="error-log"></div>

        <label>Role Requirements</label>
        <input type="text" id="role-search" class="input-black" placeholder="Search roles..." onkeyup="filterList('role-list', this.value)">
        <div id="role-list" class="multi-select"></div>

        <label style="margin-top: 15px; display: block;">Channel Restrictions</label>
        <input type="text" id="channel-search" class="input-black" placeholder="Search channels..." onkeyup="filterList('channel-list', this.value)">
        <div id="channel-list" class="multi-select"></div>

        <button class="btn-confirm" style="margin-top: 20px;" onclick="validateAndConfirm()">CONFIRM COMMAND</button>
    </div>
</div>

<script>
    // Fix 1: Intelligent Editor Mode
    function updateEditorMode() {
        const lang = document.getElementById('cmd-lang').value;
        const modeMap = {
            'javascript': 'ace/mode/javascript',
            'python': 'ace/mode/python',
            'golang': 'ace/mode/golang'
        };
        editor.session.setMode(modeMap[lang]);
        document.getElementById('error-box').style.display = 'none'; // Clear old errors
    }

    // Fix 2: Search Function for Roles/Channels
    function filterList(listId, query) {
        const items = document.getElementById(listId).getElementsByClassName('multi-item');
        const q = query.toLowerCase();
        for (let item of items) {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(q) ? 'flex' : 'none';
        }
    }

    // Fix 3: Smarter Validation
    function validateAndConfirm() {
        const code = editor.getValue();
        const lang = document.getElementById('cmd-lang').value;
        const errorBox = document.getElementById('error-box');
        errorBox.style.display = 'none';

        if (lang === "javascript") {
            try {
                new Function(code);
            } catch (e) {
                errorBox.innerHTML = `<b>JavaScript Error:</b> ${e.message}`;
                errorBox.style.display = 'block';
                return;
            }
        } 
        // Python/Go validation is handled server-side during the test run
        saveToServer();
    }

    async function saveToServer() {
        const selectedRoles = Array.from(document.querySelectorAll('#role-list input:checked')).map(i => i.value);
        const selectedChannels = Array.from(document.querySelectorAll('#channel-list input:checked')).map(i => i.value);
        
        const command = {
            id: Date.now(),
            lang: document.getElementById('cmd-lang').options[document.getElementById('cmd-lang').selectedIndex].text,
            type: document.getElementById('cmd-type').value,
            prefix: document.getElementById('cmd-prefix').value,
            trigger: document.getElementById('cmd-trigger').value,
            code: editor.getValue(),
            roles: selectedRoles,
            channels: selectedChannels
        };

        await fetch('/api/save-command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ guildId: currentGuildId, command })
        });
        alert("Command Confirmed!");
    }
</script>
</body>
</html>
    
